---
title: "EDLD 652 Final"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    social: menu
    source_code: https://chhr1s.github.io/GA_DOE_Public/docs/index.html/
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(rio)
library(here)
library(janitor)
library(sf)
library(leaidr)
library(tigris)
library(gt)
library(lme4)
library(lmerTest)
library(glmertree)
library(plotly)
library(colorblindr)
options(tigris_use_cache = TRUE)
options(tigris_class = "sf")
```


```{r import, include = F}
frl <- import(here("Data", "Free Reduced Lunch (FRL) Fiscal Year2019 Data Report_Schools.csv")) %>% 
  clean_names() %>% 
  mutate(kk_12_percent_frl = as.numeric(kk_12_percent_frl), 
         kk_12_percent_frl = replace_na(kk_12_percent_frl, 0)) %>% 
  separate(col = school_id_school_name, 
           into = c('school_id','school_name'), 
           sep = " - ",
           extra = "merge") %>% 
  filter(system_name != 'N/A') %>% 
  select(-system_id)

all_students <-  #https://gosa.georgia.gov/report-card-dashboards-data/downloadable-data
  import(
    here('Data',
         'Enrollment_By_Grade_Level_2019_Dec2nd_2019.csv')) %>%
  clean_names() %>% 
  filter(enrollment_period == 'Fall') %>% 
  group_by(instn_name) %>% 
  summarize(num_students = sum(enrollment_count)) %>% 
  transmute(school_name = instn_name, 
            total = num_students)


school_demos <- import(
    here('Data', #https://gosa.georgia.gov/report-card-dashboards-data/downloadable-data
  'Enrollment_by_Subgroups_Programs_2019_OCT_22_2020.csv')) %>% 
  clean_names() %>% 
  transmute(school_name = instn_name,
            system_name = school_dstrct_nm,
            perc_black = enroll_percent_black,
            perc_hisp = enroll_percent_hispanic, 
            perc_white = enroll_percent_white, 
            perc_non_white = 100-perc_white, 
            perc_migrant = enroll_percent_migrant, 
            perc_esol = enroll_pct_esol
            )
  
schools <- school_demos %>%
  full_join(all_students)

disc_action <- import(
  here("Data", 
       "sr2019_discipline_action_counts_sch.xlsx")
  ) %>% 
  clean_names() %>% 
  select(-grade_range, -school_year) %>% 
  left_join(frl)


dat <- disc_action %>% 
  inner_join(schools) %>% # if this is left_join I have to impute
  group_by(system_name) %>% 
  mutate(harsh =
           out_of_school_suspension_oss +
           juvenile_court_referral +
           physical_restraint +
           corporal_punishment +
           permanent_expulsion, # +
           #in_school_suspension_iss,
         harsh_ps = harsh/total, 
         harsh_per_100 = harsh_ps*100,
         district = factor(system_name),
         school_name = factor(school_name), 
         fac_schtype = factor(fac_schtype), 
         perc_frl = kk_12_percent_frl 
         ) %>% 
  mutate(district_size = sum(total, na.rm = T), 
         d_black = sum(total*perc_black, na.rm = T)/district_size, 
         d_hisp = sum(total*perc_hisp, na.rm = T)/district_size, 
         d_non_white = sum(total*perc_non_white, na.rm = T)/district_size, 
         d_esol = sum(total*perc_esol, na.rm = T)/district_size,
         d_migrant = sum(total*perc_migrant, na.rm = T)/district_size,
         d_frl = sum(total*kk_12_percent_frl, na.rm = T)/district_size, 
         d_harsh = sum(harsh, na.rm = T)/district_size) %>% 
  ungroup() 
dat_small <- 
  dat %>% 
  select(district, 
         district_size, 
         school_name, 
         fac_schtype, 
         total,
         contains('frl'),
         contains('black'), 
         contains('hisp'), 
         contains('white'), 
         contains('migrant'), 
         contains('esol'), 
         contains('harsh')) %>% 
  select(-kk_12_percent_frl)

dat_long <- dat_small %>% 
  pivot_longer(contains('perc'), 
               names_to = 'school_demos', 
               names_prefix = 'perc_', 
               values_to = 'percents')

#dat_small[rowSums(is.na(dat_small)) > 0,]

rm(list=setdiff(ls(), c("dat", 'dat_small', 'dat_long')))
```


```{r include = F}
original_TA_plot <-
dat_long  %>% 
  filter(school_name != 'Georgia Cyber Academy' & 
           fac_schtype %in% c('M', 'H') & 
           school_demos != 'white'
           ) %>% 
  mutate(school_demos = ordered(school_demos, 
                                c('hisp', 'frl', 'esol', 'non_white', 'black', 'migrant'))) %>% 
  ggplot(aes(x = percents, 
             y = harsh_per_100, 
             color = school_demos
                 )) +
  geom_point(alpha = 0.8, 
             show.legend = F) + 
  geom_smooth(method = 'lm', 
              color = 'black', 
              size = 0.2, 
              show.legend = F) 

```

```{r}
formatted_TA_plot <- 
  original_TA_plot +
  labs(x = 'Percent of School', 
       y = 'Number of Harsh Punishments
per 100 Students', 
       title = 'Harsh Punishments per 100 Students
by School Demographics') +
  scale_color_OkabeIto() +
  theme_minimal(base_size = 16) +
  facet_wrap(~school_demos, 
             labeller = as_labeller(
                 c(`black` = '% Black',
                   `hisp` = '% Hispanic',
                   `frl` = '% FRL', 
                   `esol` = '% ESOL',
                   `migrant` = '% Migrant',
                   `non_white` = '% Non-White')), 
             ncol = 6) + #scales = 'free' 
  theme(axis.line = element_line(size = 1))

```


```{r, echo = F}
summary <- dat_small %>% 
  mutate(`Quintile of Percent Black Students` = ntile(perc_black, 5)) %>% 
  group_by(`Quintile of Percent Black Students`) %>% 
  summarize(`Average Harsh Punishments/Student` = mean(harsh_ps))

comparison <- summary$`Average Harsh Punishments/Student`[1]

percent_change <- summary %>% 
  mutate(`% Increase from 1st` = 
           (`Average Harsh Punishments/Student`- comparison)/comparison*100)
```

```{r, eval = T, include = F}
# Geographic Data (Teachers & Admin Page)
GA_sf <- 
  lea_get(state = 'GA') %>% 
  st_as_sf() %>% 
  mutate(district = 
           str_replace(string = NAME, 
                       pattern = " District", ""), 
         district = 
           str_replace(string = district, 
                       pattern = " Schools", ""), 
         district = 
           str_replace(string = district, 
                       pattern = " School", "")
         )
```

```{r, eval = T, include = F}
#disc_demo %>% filter(system_name == 'Macon County')

dat_district <- 
  dat_small %>% 
  select(district, district_size, starts_with('d_')) %>% 
  unique()

GA_districts <- 
  GA_sf %>% 
  left_join(dat_district) %>% 
  mutate(harsh_qt = factor(ntile(d_harsh, 5)), 
         black_qt = factor(ntile(d_black, 5)),
         frl_qt = ntile(d_frl, 5), 
         harsh_3 = ntile(d_harsh, 3), 
         black_3 = ntile(d_black, 3), 
         frl_3 = ntile(d_frl, 3)) 

```



```{r include=FALSE}
b_map <- GA_districts %>% 
  mutate(`Quintile Harsh Punishment` = harsh_qt,
    Demographics = paste('\n', '(', district, ')',
                         '\n', round(d_black, 1), '% Black', 
                         '\n', round(d_hisp, 1), '% Hispanic', 
                         '\n', round(d_migrant,1), '% Migrant', 
                         '\n', round(d_frl, 1), '% FRL', 
                         sep = "")
         ) %>% 
  ggplot(aes(geometry = geometry)) + 
  geom_sf(aes(fill = `Quintile Harsh Punishment`, text = Demographics)) +
  scale_fill_manual(
    values =
      c('#a9c2f4',
        '#7ca2ee',
        '#4f82e8',
        '#2262e2',
        '#184eb9'),
    na.value = '#6a6b6c') +
  theme_void()  +
  labs(fill = 'Quintile',
       title = 'Number of Harsh Punishments per Student')


plotly_map1 <- 
  ggplotly(b_map) 

```

General
===

Column {data-width=650} 
-----------------------------------------------------------------------

### General 

```{r}
plotly_map1 
```


Column {data-width=350}
-----------------------------------------------------------------------

### Chart B

```{r}
percent_change %>% 
  round(digits = 3) %>% 
  gt() %>% 
  tab_header(
    title = '',
  )
```

### Chart C


School Admin
===

```{r}
formatted_TA_plot
```

Researchers
===

```{r, eval = F}


```

```{r, include = F, eval = F}
lmer <- lmer(data = dat_small, 
     formula = 
       harsh ~
       total +
       fac_schtype + 
       perc_black + 
       perc_hisp + 
       perc_migrant + 
       perc_esol + 
       frl +
       d_black + 
       d_hisp + 
       d_migrant + 
       d_esol + 
       d_frl +
       (1 | district))

summary(lmer)



lmertree <- 
  lmertree(data = dat_small, 
     formula = 
       harsh ~ total + perc_black | 
       (1 | district/fac_schtype) | 
       total +
       fac_schtype + 
       perc_black + 
       perc_hisp + 
       perc_migrant + 
       perc_esol + 
       frl +
       d_black + 
       d_hisp + 
       d_migrant + 
       d_esol + 
       d_frl, 
     alpha = 0.001, 
     bonferroni = T, 
     minsize = 224)

lmertree
summary(lmertree$tree)

sqrt(sum(residuals(lmertree)^2))
sqrt(sum(residuals(lmer)^2))

plot(lmertree, ask = F, which = 'all')


py <- lmertree$tree[1]

ggparty(py) +
  geom_edge() +
  geom_edge_label() +
  geom_node_label(aes(label = splitvar), ids = "inner") +
  geom_node_plot(gglist = list(geom_point(aes(x = perc_black, y = harsh, color = perc_black),
                                          alpha = 0.5
    # geom_density(aes(x = harsh_per_100)), lims(x = c(0,100))
    #                            #xlab("play")
    ), geom_smooth(aes(x = perc_black, y = harsh), se = T, method = 'lm')))

```

```{r, include = F, eval = F}
dat_small <- 
  dat_small %>% 
  mutate(prediction = predict(lmertree))

dat_small %>% 
  ggplot(aes(x = prediction, y = harsh)) + 
  geom_point(aes(color = perc_black, shape = fac_schtype), alpha = 0.5) +
  coord_fixed() + 
  lims(x = c(0, 2500), y = c(0,2500)) + 
  geom_abline(intercept = 0, slope = 1) + 
  facet_wrap(~fac_schtype)

dat_small <- dat_small %>% 
  mutate(difference = abs(harsh - prediction), 
         act_difference = harsh - prediction, 
         sign = if_else(harsh - prediction < 0, 0, 1), # positives have higher than predicted
         difference_rank = factor(ntile(difference, 10)), 
         very_bad = factor(if_else(difference_rank %in% c(10), 1, 0)))



unusual_schools <-
  glmer(data = dat_small,
     formula = sign ~ 
       #harsh +
       #total +
       fac_schtype + 
       perc_black + 
       perc_hisp + 
       perc_migrant + 
       perc_esol + 
       frl +
       d_black +
       d_hisp +
       d_migrant +
       d_esol +
       d_frl +
       (1 | district), 
     family = 'binomial'
     ) 

summary(unusual_schools)

dat_small %>% 
  ggplot(aes(x = prediction, y = harsh)) + 
  geom_point(aes(color = very_bad, shape = fac_schtype), alpha = 0.5) +
  coord_fixed() + 
  lims(x = c(0, 2500), y = c(0,2500)) + 
  geom_abline(intercept = 0, slope = 1) + 
  facet_wrap(~fac_schtype)
```

```{r, include = F, eval = F}
misfits <- 
  dat_small %>%
  filter(very_bad == 1) 
  # group_by(sign) %>% 
  # summarize(average_perc_black = mean(perc_black))

rf_def_mod <-
  rand_forest() %>%
  set_engine("ranger",
             num.threads = cores, #argument from {ranger}
             importance = "permutation", #argument from {ranger}
             verbose = TRUE) %>% #argument from {ranger} 
  set_mode("classification")

```


```{r, include = F, eval = F}
agg_disc_perc_complete %>% 
  mutate(lm1 = predict(lm1)) %>% 
  ggplot(aes(x = lm1, y = harsh)) + 
  geom_point() +
  geom_abline(intercept = 0, slope = 1) + 
  lims(x = c(0, .3), y = c(0, .3))


disagg_perc_complete %>% 
  mutate(lm2 = predict(lm2)) %>% 
  ggplot(aes(x = lm2, y = harsh)) + 
  geom_point()+
  geom_abline(intercept = 0, slope = 1) + 
  lims(x = c(0, .3), y = c(0, .3))

disagg_perc_complete %>% 
  mutate(lmer1 = predict(lmer1)) %>% 
  ggplot(aes(x = lmer1, y = harsh)) + 
  geom_point()+
  geom_abline(intercept = 0, slope = 1) + 
  lims(x = c(0, .3), y = c(0, .3))

```

```{r, include = F, eval = F}
t1 <-tibble(.rows = 1)

for (i in list(lm1, lm2, lmer1)){
  next_resid <<-tibble(sqrt(mean(residuals(i)^2)), .rows = 1)
  t1 <<- cbind(t1, next_resid) 
}
columns <- 
  list('lm1', 'lm2', 'lmer1')

colnames(t1) <- columns

rmse <- 
  t1 %>% 
  pivot_longer('lm1':'lmer1', 
               names_to = 'model',
               values_to = 'rmse') %>% 
  mutate(model = factor(model, levels = columns, 
                        labels = c('simple linear model aggregated',
                                   'simple linear model disaggregated',
                                   'simple mixed-effects model')))
rmse
```
