---
title: "EDLD 652 Final"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    social: menu
    source_code: https://chhr1s.github.io/GA_DOE_Public/docs/index.html/
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(rio)
library(here)
library(janitor)
library(sf)
library(leaidr)
library(tmap)
library(tigris)
library(tmaptools)
library(gt)
library(cowplot)
library(lme4)
library(lmerTest)
#library(mice)
options(tigris_use_cache = TRUE)
options(tigris_class = "sf")
```


```{r import, include = F}
frl <- import(
  here("Data", 
       "Free Reduced Lunch (FRL) Fiscal Year2019 Data Report.csv")
  ) %>% 
  clean_names() %>% 
  mutate(kk_12_percent_frl = 
           as.numeric(kk_12_percent_frl))

total_students <- import(
  here("Data", 
       'FTE Enrollment by Grade Fiscal Year2019-1 Data Report.csv')
  ) %>% 
  clean_names() %>% 
  select(system_name, total)

race_gen <- import(
  here("Data", 
       "FTE Enrollment by Race_Ethnicity and Gender Fiscal Year2019-1 Data Report.csv")
  ) %>% 
  clean_names()

disc_action <- import(
  here("Data", 
       "sr2019_discipline_action_counts_sch.xlsx")
  ) %>% 
  clean_names() %>% 
  select(-grade_range, -school_year) 

# aggregated disc action
agg_disc <-
  disc_action %>% 
  group_by(system_name) %>% 
  summarize(oss = mean(out_of_school_suspension_oss), 
            juvie_ref = mean(juvenile_court_referral), 
            physical_restraint = mean(physical_restraint), 
            corporal_punishment = mean(corporal_punishment), 
            detention = mean(detention), 
            permanent_expulsion = mean(permanent_expulsion), 
            harsh = oss + 
              juvie_ref + 
              physical_restraint + 
              corporal_punishment + 
              detention + 
              permanent_expulsion
            )

race_gen <- 
  race_gen %>% 
  filter(gender == 'Total') %>% 
  mutate(ethnic_hispanic = as.numeric(ethnic_hispanic), 
       race_american_indian = as.numeric(race_american_indian), 
       race_asian = as.numeric(race_asian), 
       race_black = as.numeric(race_black), 
       race_pacific_islander = as.numeric(race_pacific_islander), 
       race_white = as.numeric(race_white), 
       two_or_more_races = as.numeric(two_or_more_races)
       ) %>% 
  select(-gender) %>%  
  left_join(total_students) %>% 
  left_join(frl) %>% 
  filter(system_name != 'State-Wide') %>% 
  transmute(system_name,
            prop_white = race_white/total, 
            prop_black = race_black/total, 
            prop_hisp = ethnic_hispanic/total, 
            prop_non_white = 1 - prop_white,
            total, 
            frl = kk_12_percent_frl
            ) %>% 
  mutate(prop_non_white = 
           if_else(is.na(prop_non_white), 
                   prop_black,  
                   # there is one district for which this is an issue
                   # International Academy of Smyrna
                   prop_non_white)) 

# disaggregated
disagg_prop <-
  disc_action %>%
  left_join(race_gen) %>%
  mutate(harsh =
           out_of_school_suspension_oss +
           juvenile_court_referral +
           physical_restraint +
           corporal_punishment +
           permanent_expulsion +
           in_school_suspension_iss,
         harsh = harsh/total,
         total, 
         district = factor(system_name)
         ) %>%
  select(school_name,
         district,
         contains('frl'),
         contains('prop'),
         harsh,
         total
         )


#aggregated and proportions
agg_disc_prop <- 
  left_join(race_gen, agg_disc)  %>% 
  filter(system_name !='N/A') %>% 
  mutate(district = factor(system_name), 
         oss = oss/total, 
         juvie_ref = juvie_ref/total,
         physical_restraint = physical_restraint/total, 
         corporal_punishment = corporal_punishment/total, 
         detention = detention/total, 
         permanent_expulsion = permanent_expulsion/total, 
         harsh = harsh/total) 
```


```{r}
agg_disc_prop_complete <- agg_disc_prop %>% 
  select(prop_hisp, prop_black, harsh, district, frl) %>% 
  mice::mice(seed = 022021, print = F) %>% 
  mice::complete()

disagg_prop_complete <- disagg_prop %>% 
  select(prop_hisp, prop_black, harsh, district, frl) %>% 
  mice::mice(seed = 022021, print = F) %>% 
  mice::complete()

```

```{r, include = F}
grad <- import(here("Data", "4-Year Cohort Graduation Rate State District School by Subgroups 11_10_20.xlsx")) %>% # technically a 4 year graduation rate
  clean_names() %>%
  # we're filtering people out here, based on having enough people to graduate
  filter(graduation_class_size != 'Too Few Students' & reporting_level == 'School') %>%
  select(-reporting_label, -reporting_level) %>%
  mutate(school_id = factor(school_id),
         system_id = factor(system_id),
         system_name = factor(system_name),
         school_name = factor(school_name),
         graduation_class_size = as.double(graduation_class_size),
         total_graduated = as.double(total_graduated),
         graduation_rate = as.double(graduation_rate)
         ) %>%
  drop_na()

# import(here("Data", "4-Year Cohort Graduation Rate State District School by Subgroups 11_10_20.xlsx")) %>%
#    clean_names() %>%
#   count(graduation_class_size) %>% arrange(desc(n))

#grad_demo <- inner_join(demo_dat, grad,  by = c("system_id", "system_name", "school_id", "school_name"))
```

```{r, include = F}
# complete_grad_dat <- left_join(grad_demo, disc_demo) %>% 
#   filter(graduation_rate > 0) %>% 
#   select(graduation_rate, oss_adj, contains('prop'), kk_12_percent_frl, school_name, fac_schtype, system_name) %>% 
#   drop_na()
```


```{r without_labs, include = F}
## add some text explaining these
background <- agg_disc_prop %>% 
  filter(!is.na(district) & !is.na(oss) & !is.na(prop_non_white)) %>% 
  group_by(oss < 0.05, 
           oss < 0.10 & oss >= 0.05, 
           oss < 0.15 & oss >= 0.10, 
           oss < 0.20 & oss >= 0.15,
           oss < 0.25 & oss >= 0.20,
           oss >= 0.25
           ) %>% 
  summarize(average_nw_prop = mean(prop_non_white), 
            average_oss = mean(oss)) %>% 
  ungroup() %>% 
  select(average_nw_prop, average_oss) %>% 
  mutate(xmin = rev(c(0, 0.05, 0.10, 0.15, 0.20)), 
         xmax = rev(c(0.049, 0.099, 0.149, 0.199, 0.251))
         )
general_plot <- 
agg_disc_prop %>% 
  filter(!is.na(district) & !is.na(oss)) %>% 
  ggplot() + 
   geom_rect(inherit.aes = F,
            data = background, 
            aes(xmin = xmin, xmax = xmax, ymin = -Inf, ymax = Inf, 
                fill = average_nw_prop), 
            alpha = 0.9) +
  geom_col(inherit.aes = F,
           aes(y = fct_reorder(district, oss), 
             x = oss,
             fill = prop_non_white), color = 'gray30', size = 0.1, alpha = 0.8) + 
  theme(axis.text.y = element_blank(), 
        plot.title.position = 'plot', 
        axis.ticks.y = element_blank(), 
        panel.grid.minor = element_blank(), 
        panel.grid.major.y = element_blank(), 
        panel.grid.major.x = element_line(color = 'gray30'), 
        legend.position = 'bottom'
        ) + 
  labs(y = 'Individual Districts', 
       x = 'District Average OSS per Student', 
       title = 'District Averages of Out of School Suspensions per Student by Proportion Non-White', 
       fill = 'Proportion
Non-White') +
  scale_fill_distiller(palette = 
                         'Blues', 
                       type = 'seq', 
                       direction = 1)
```

```{r, echo = F}
# General Plot
labeled_plot <- 
  general_plot + 
  geom_label(inherit.aes = F, 
             show.legend = F,
             data = background, aes(
             label = round(average_nw_prop, 2),
             x = xmin + 0.025, 
             y = rep(20, 5), 
             #color = average_nw_prop
             ),
             fill = 'coral3') +
  geom_label(inherit.aes = F, 
             show.legend = F,
             data = background, aes(
             label = round(average_oss, 2),
             x = xmin + 0.025, 
             y = rep(40, 5),
             #color = average_oss
             ),
             fill = 'coral') +
  coord_cartesian(clip = 'off') +
  geom_label(inherit.aes = F, 
            x = 0.025, 
            y = -55, 
            label = 'Avg. Proportion\nNon-White\nwithin block', 
            fill = 'coral3') + 
  geom_label(inherit.aes = F, 
            x = 0.225, 
            y = -55, 
            label = 'Average OSS\nPer Student\nwithin block', 
            fill = 'coral') #+
  # scale_color_distiller(palette = 
  #                        'Blues', 
  #                      type = 'seq', 
  #                      direction = 1)
```

```{r, echo = F}
summary <- agg_disc_prop %>% 
  filter(!is.na(district) & !is.na(oss) & !is.na(prop_non_white)) %>% 
  mutate(`Quintile non-White` = ntile(prop_non_white, 5)) %>% 
  group_by(`Quintile non-White`) %>% 
  summarize(`Average OSS/Student` = mean(oss))

comparison <- summary$`Average OSS/Student`[1]

percent_change <- summary %>% 
  mutate(`% Increase from 1st` = 
                     (`Average OSS/Student` - comparison)/comparison*100)
```


```{r, eval = T, include = F}
# Geographic Data (Teachers & Admin Page)
GA_sf <- 
  lea_get(state = 'GA') %>% 
  st_as_sf() %>% 
  mutate(district = 
           str_replace(string = NAME, 
                       pattern = " District", ""), 
         district = 
           str_replace(string = district, 
                       pattern = " Schools", ""), 
         district = 
           str_replace(string = district, 
                       pattern = " School", "")
         )
```

```{r, eval = T, include = F}
#disc_demo %>% filter(system_name == 'Macon County')
GA_sf <- 
  GA_sf %>% left_join(agg_disc_prop)
```

```{r, include = F}
#GA_sf <- GA_sf %>% left_join(oss)
#grad_plot <- GA_sf %>% left_join(complete_grad_dat, by = c('system_name'))
```

```{r}
GA_sf <- 
  GA_sf %>% 
  mutate(oss_qt = ntile(oss, 5), 
         pnw_qt = ntile(prop_non_white, 5),
         oss_3 = ntile(oss, 3), 
         pnw_3 = ntile(prop_non_white, 3))
```

```{r}
oss_map <- 
  tm_shape(GA_sf) +
  tm_polygons(c('oss_qt', 'pnw_qt'),
              labels = c('1st quintile',
                         '2nd quintile',
                         '3rd quintile',
                         '4th quintile',
                         '5th quintile',
                         'Missing'),
              palette = 'Blues', 
              title = 'Quintiles', 
              legend.hist = F)  + 
  tm_facets(sync = F, ncol = 2) + 
  tm_layout(legend.outside = T, 
            panel.labels = c("OSS per Student", "Prop. Non-White"),)

```


```{r}
# bivariate plot

pal <- 
  GA_sf %>% 
  select(ends_with('_3')) %>% 
  count(oss_3, pnw_3) %>% 
  arrange(oss_3, pnw_3) %>% 
  drop_na(oss_3, pnw_3) %>% 
  mutate(pal = c("#F3F3F3", "#C3F1D5", "#8BE3AF",
                 "#EBC5DD", "#C3C5D5", "#8BC5AF",
                 "#E7A3D1", "#C3A3D1", "#8BA3AE"))

bivar_map <- st_join(GA_sf, pal) %>% 
  ggplot() + 
  geom_sf(aes(fill = pal, color = pal)) +
  guides(fill = "none", color = "none") +
  scale_fill_identity() +
  scale_color_identity()

leg <- ggplot(pal, aes(oss_3, pnw_3)) +
  geom_tile(aes(fill = pal)) +
  scale_fill_identity() +
  coord_fixed() +
  labs(x = expression("OSS/Student" %->% ""),
       y = expression("Prop Non-White" %->% "")) +
  theme(axis.text = element_blank(),
        axis.title = element_text(size = 12))

ggdraw() +
  draw_plot(bivar_map + theme_void(), 0.1, 0.1, 1, 1) +
  draw_plot(leg, -0.05, 0, 0.3, 0.3)
```

General
===

Column {data-width=650}
-----------------------------------------------------------------------

### General



```{r}
labeled_plot 
```

```{r, eval = F}
par(mfrow=c(1,2))

tm_shape(hs_oss) + tm_polygons('average_oss')

tm_shape(hs_oss) + tm_polygons('average_prop_non_white')
```

```{r, eval = F}
par(mfrow=c(1,2))

tm_shape(grad_plot) + tm_polygons('graduation_rate')
```

```{r, eval = F}
disc_demo %>% 
  filter(fac_schtype %in% c('M', 'H')) %>% 
  group_by(system_name, fac_schtype) %>% 
  summarize(mean_oss_adj = mean(oss_adj),
            se = sd(oss_adj)/sqrt(n()), 
            mean_prop_non_white = mean(prop_non_white)) %>% 
  ungroup() %>% 
  #filter(mean_oss_adj > 0.2) %>% 
  #summarize(mean_oss = mean(out_of_school_suspension_oss), 
  #          se = sd(out_of_school_suspension_oss)/sqrt(n())) %>% 
  ggplot(aes(x = mean_oss_adj, 
             y = fct_reorder(system_name, mean_oss_adj), 
             color = fac_schtype, 
             size = mean_prop_non_white)) + 
  geom_point(alpha = 0.5) +
  facet_wrap(~fac_schtype) +
  theme_minimal() +
  labs(y = NULL, 
       x = 'Out of School Suspensions per Student', 
       title = 'Average OSS Rate for Georgian Middle and High Schools in each District'
       ) +
  theme(plot.title.position = 'plot', 
        axis.text.y = element_blank())
```

```{r, eval = F}
disc_demo %>% 
  group_by(fac_schtype) %>% 
  summarize(mean_oss_adj = mean(oss_adj)) %>% 
  ggplot(aes(x = mean_oss_adj, 
             y = fct_reorder(fac_schtype, mean_oss_adj), 
             fill = fac_schtype)) + 
  geom_col(show.legend = F,
           alpha = 0.75) + 
  theme_minimal() +
  labs(x = 'Average OSS/student', 
       y = 'School Type', 
       title = 'Average Out of School Suspension per Student by School Type') + 
  scale_fill_viridis_d()
```

```{r, eval = F}
# are quartiles clean/interprettable? 
# add geom_label()
disc_demo <- disc_demo %>% 
  filter(fac_schtype != 'K12') %>% 
  mutate(quartiles = ntile(prop_non_white, 4), 
         tenths = ntile(prop_non_white, 10), 
         hundreds = ntile(prop_non_white, 100))

disc_demo %>% 
  filter(fac_schtype != 'K12') %>% 
  group_by(fac_schtype, quartiles) %>% 
  mutate(mean_oss_adj = mean(oss_adj)) %>% 
  ggplot(aes(fill = mean_oss_adj, 
             y = fct_reorder(fac_schtype, mean_oss_adj),
             x = quartiles, 
             group = fac_schtype)) + 
  geom_tile(color = 'white') +
  coord_fixed() +
  theme_minimal() + 
  scale_fill_continuous(#name = 'Proportion',
                        type = 'viridis') + 
  theme(legend.position = 'bottom', 
        plot.title.position = 'plot') +
  labs(y = 'School Type',
       x = 'Quartiles of Proportion Non-White', 
       color = 'Average OSS/Student', 
       title = 'Heatmap of Average OSS/Student by School Type 
       and Quartile of Proportion Non-White') 
```

Column {data-width=350}
-----------------------------------------------------------------------

### Chart B

```{r}
percent_change %>% 
  round(digits = 3) %>% 
  gt() %>% 
  tab_header(
    title = 'Average Out of School Suspension Per Student by Quintile Proportion non-White',
  )
```

```{r}
# GA_sf %>%
#   ggplot() +
#   geom_sf(aes(geometry = geometry)) 
#print(GA_sf)
```

```{r}
#ggplot(data = mtcars, aes(x = disp, y = mpg)) + geom_point()

#quartz()
# GA_sf %>%
#   #select(geometry, kk_12_percent_frl) %>% 
#   ggplot() +
#   geom_sf(aes(fill = kk_12_percent_frl))
```

### Chart C

```{r}
# fill = kk_12_percent_frl
```

School Admin
===

```{r}
oss_map
```

```{r}
# bivariate plot
ggdraw() +
  draw_plot(bivar_map + theme_void(), 0.1, 0.1, 1, 1) +
  draw_plot(leg, -0.05, 0, 0.3, 0.3)
```

Researchers
===

```{r, eval = F}

lm1 <- lm(data = agg_disc_prop_complete, 
   formula = harsh ~ prop_black + prop_hisp + frl)
summary(lm1)

lm2 <- lm(data = disagg_prop_complete, 
   formula = harsh ~ prop_black + prop_hisp + frl)
summary(lm2)

lmer1 <- lmer(data = disagg_prop_complete, 
   formula = harsh ~ prop_black + prop_hisp + frl + (1 | district))
summary(lmer1)  

agg_disc_prop_complete %>% 
  mutate(lm1 = predict(lm1)) %>% 
  ggplot(aes(x = lm1, y = harsh)) + 
  geom_point() +
  geom_abline(intercept = 0, slope = 1) + 
  lims(x = c(0, .3), y = c(0, .3))


disagg_prop_complete %>% 
  mutate(lm2 = predict(lm2)) %>% 
  ggplot(aes(x = lm2, y = harsh)) + 
  geom_point()+
  geom_abline(intercept = 0, slope = 1) + 
  lims(x = c(0, .3), y = c(0, .3))

disagg_prop_complete %>% 
  mutate(lmer1 = predict(lmer1)) %>% 
  ggplot(aes(x = lmer1, y = harsh)) + 
  geom_point()+
  geom_abline(intercept = 0, slope = 1) + 
  lims(x = c(0, .3), y = c(0, .3))

# 
# lm <- lm(harsh_ps ~
#            1, 
#          data = disagg_prop_complete)
# lm_full <- lm(harsh_ps ~ 
#          total +
#          prop_white + 
#          prop_black + 
#          prop_hisp + 
#          frl, 
#          data = disagg_prop_complete)
# 
# lmer0 <- 
#   lmer(harsh_ps ~ 
#          1 + (1 | system_name), 
#        data = disagg_prop_complete, 
#        REML = F) 
# #summary(lmer0)
# 
# 
# lmer1 <- 
#   lmer(harsh_ps ~ 
#          total +
#          (1 | system_name), 
#        data = disagg_prop_complete, 
#        REML = F) 
# #summary(lmer1)
# 
# lmer2 <- 
#   lmer(harsh_ps ~ 
#          total + 
#          prop_white + 
#          prop_black + 
#          prop_hisp + 
#          (1 | system_name), 
#        data = disagg_prop_complete, 
#        REML = F) 
# #summary(lmer2)
# 
# lmer3 <- 
#   lmer(harsh_ps ~ 
#          total +
#          prop_white + 
#          prop_black + 
#          prop_hisp + 
#          frl + 
#          (1 | system_name), 
#        data = disagg_prop_complete, 
#        REML = F) 
#summary(lmer3)

# anova(lmer0, lmer1)
# anova(lmer1, lmer2)
# anova(lmer2, lmer3)
```

```{r}
plot_dat <- 
  disagg_prop_complete %>% 
  mutate(lm1 = predict(lm1), 
         lm2 = predict(lm2), 
         lmer1 = predict(lmer1)) %>% 
  # mutate(lm = predict(lm), 
  #        lm_full = predict(lm_full),
  #   lmer0_pred = predict(lmer0), 
  #        lmer1_pred = predict(lmer1), 
  #        lmer2_pred = predict(lmer2), 
  #        lmer3_pred = predict(lmer3)) %>% 
  pivot_longer(lm1:lmer1, 
              names_to = 'model', 
              values_to = 'predicted')
```

```{r}
plot_dat %>% 
  ggplot(aes(x = harsh_ps, 
             y = predicted, 
             color = model)) +
  geom_point(alpha = 0.4) +
  geom_abline(intercept = 0, slope = 1) +
  facet_wrap(~model) + 
  coord_fixed()
```

```{r, eval = F}
#t1 <-tibble(.rows = 1924)
t2 <-tibble(.rows = 1)
#t3 <- tibble(.rows = 1)

#for (i in list(lm, lm_full, lmer0, lmer1, lmer2, lmer3)){
for (i in list(lm1, lm2, lmer1)){
  #next_pred <- tibble(predict(i), .rows = 1924)
  next_resid <<-tibble(sqrt(mean(residuals(i)^2)), .rows = 1)
  #next_rsq <- tibble(summary(i)$r.square, .rows = 1)
  #t1 <<- cbind(t1, next_pred) 
  t2 <<- cbind(t2, next_resid) 
  #t3 <<- cbind(t3, next_rsq) 
}
columns <- 
  list('lm1', 'lm2', 'lmer1')
  # list('lm',
  #      'lm_full',
  #      'lmer0',
  #      'lmer1',
  #      'lmer2',
  #      'lmer3')

#colnames(t1) <- columns
colnames(t2) <- columns
#colnames(t3) <- columns

t2_long <- 
  t2 %>% 
  pivot_longer('lm1':'lmer1', 
               names_to = 'model',
               values_to = 'rmse')

# t3_long <- 
#   t3 %>% 
#   pivot_longer('lm':'lmer3',
#                names_to = 'model',
#                values_to = 'rsq')

fit_stats <- t2_long #%>% 
  #left_join(t2_long, t3_long, by = 'model') %>% 
 # mutate(model = factor(model, levels = columns, 
                        # labels = c('intercept lm', 
                        #            'large lm', 
                        #            'intercept lmer',
                        #            'school size lmer',
                        #            'size + race/eth lmer', 
                        #            'size + race/eth + frl lmer'))) 
fit_stats
```
