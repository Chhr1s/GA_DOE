---
title: "EDLD 652 Final"
output: 
  flexdashboard::flex_dashboard:
    css: css_script.css
    orientation: columns
    vertical_layout: fill
    source_code: https://github.com/Chhr1s/GA_DOE_Public/blob/main/docs/index.Rmd
---

```{r setup}
library(flexdashboard)
library(reactable)
library(tidyverse)
library(rio)
library(here)
library(janitor)
library(sf)
library(leaidr)
#devtools::install_github('ivelasq/leaidr', force = T)
library(tigris)
library(glmertree)
library(plotly)
library(colorblindr)
library(ggparty)
library(gganimate)
library(mice)
options(tigris_use_cache = TRUE)
options(tigris_class = "sf")
```

```{r eval=FALSE, include=FALSE}
frl <- import(here("Data", "Free Reduced Lunch (FRL) Fiscal Year2019 Data Report_Schools.csv")) %>% 
  clean_names() %>% 
  mutate(kk_12_percent_frl = as.numeric(kk_12_percent_frl) 
         #kk_12_percent_frl = replace_na(kk_12_percent_frl, 0)
         ) %>% 
  separate(col = school_id_school_name, 
           into = c('school_id','school_name'), 
           sep = " - ",
           extra = "merge") %>% 
  filter(system_name != 'N/A') %>% 
  select(-system_id)

all_students <-  #https://gosa.georgia.gov/report-card-dashboards-data/downloadable-data
  import(
    here('Data',
         'Enrollment_By_Grade_Level_2019_Dec2nd_2019.csv')) %>%
  clean_names() %>% 
  filter(enrollment_period == 'Fall') %>% 
  group_by(instn_name) %>% 
  summarize(num_students = sum(enrollment_count)) %>% 
  transmute(school_name = instn_name, 
            total = num_students)


school_demos <- import(
    here('Data', #https://gosa.georgia.gov/report-card-dashboards-data/downloadable-data
  'Enrollment_by_Subgroups_Programs_2019_OCT_22_2020.csv')) %>% 
  clean_names() %>% 
  transmute(school_name = instn_name,
            system_name = school_dstrct_nm,
            perc_black = enroll_percent_black,
            perc_hisp = enroll_percent_hispanic, 
            perc_white = enroll_percent_white, 
            perc_migrant = enroll_percent_migrant, 
            perc_esol = enroll_pct_esol
            )
  
schools <- school_demos %>%
  full_join(all_students)

disc_action <- import(
  here("Data", 
       "sr2019_discipline_action_counts_sch.xlsx")
  ) %>% 
  clean_names() %>% 
  select(-grade_range, -school_year) %>% 
  left_join(frl)

dat <- disc_action %>% 
  left_join(schools) %>% # if this is left_join I have to impute
  group_by(system_name) %>% 
  mutate(harsh =
           out_of_school_suspension_oss +
           juvenile_court_referral +
           physical_restraint +
           corporal_punishment +
           permanent_expulsion,
         district = factor(system_name),
         school_name = factor(school_name), 
         fac_schtype = factor(fac_schtype), 
         perc_frl = kk_12_percent_frl 
         ) %>% 
  select(district, 
         school_name, 
         fac_schtype, 
         total,
         out_of_school_suspension_oss,
         juvenile_court_referral,
         physical_restraint,
         corporal_punishment,
         permanent_expulsion,
         contains('frl'),
         contains('black'), 
         contains('hisp'), 
         contains('white'), 
         contains('migrant'), 
         contains('esol'), 
         contains('harsh')) %>% 
  select(-kk_12_percent_frl)

imputed <- dat %>% 
  select(total:harsh) %>% 
  mice::mice(m = 1, seed = 12345, remove.collinear = T, print = F) %>% 
  mice::complete(1)

dat_imp <- dat %>%
  select(district, school_name, fac_schtype) %>%
  bind_cols(imputed)

dat_imp %>% rio::export(here('Data', 'Imputed.csv'))
```

```{r}
dat_imp <- import(here('Data', 'Imputed.csv')) %>% 
  select(-contains('...'))

dat_final <- dat_imp %>%
  mutate(harsh_ps = harsh/total, 
         harsh_per_100 = harsh_ps*100, 
         perc_non_white = 100-perc_white, 
         district = factor(district),
         school_name = factor(school_name)) %>% 
  group_by(district) %>% 
  mutate(district_size = sum(total, na.rm = T),
         d_black = sum(total*perc_black, na.rm = T)/district_size,
         d_hisp = sum(total*perc_hisp, na.rm = T)/district_size,
         d_non_white = sum(total*perc_non_white, na.rm = T)/district_size,
         d_white = sum(total*perc_white, na.rm = T)/district_size,
         d_esol = sum(total*perc_esol, na.rm = T)/district_size,
         d_migrant = sum(total*perc_migrant, na.rm = T)/district_size,
         d_frl = sum(total*perc_frl, na.rm = T)/district_size,
         d_harsh = sum(harsh, na.rm = T)/district_size) %>%
  ungroup()

dat_long <- dat_final %>%
  pivot_longer(contains('perc'),
               names_to = 'school_demos',
               names_prefix = 'perc_',
               values_to = 'percents')



rm(list=setdiff(ls(), c('dat_final', 'dat_long')))
```

```{r}
comparison_schools <-
  dat_final %>%
  mutate(harsh_10 = ntile(harsh_ps, 10)) %>%
  filter(harsh_10 %in% c(1,10)) %>%
  mutate(category = if_else(harsh_10 == 1, 'Fewest', 'Most')) %>% 
  select(-district, 
         -contains('non_white'),
         -district_size, 
         -school_name, 
         -fac_schtype,
         -starts_with('d_')) %>% 
  pivot_longer(starts_with('perc_'),
               names_to = 'demographics', 
               names_prefix = 'perc_',
               values_to = 'percent') 
```

```{r}
school_plot <- 
comparison_schools %>% 
  ggplot(aes(y = 
               fct_reorder(demographics, percent), 
             x = percent)) + 
  geom_jitter(aes(color = category, 
                  shape = category), 
              size = 2,
              width = 0,
              alpha = 0.6) + 
  lims(x = c(0,100)) +
  scale_x_continuous(labels = scales::percent_format(scale = 1)) +
  scale_y_discrete(breaks = c(
    'black', 
    'frl', 
    'white',
    'hisp', 
    'esol', 
    'migrant'
  ),
    labels = c(
    'Black', 
    'FRL',
    'White', 
    'Hispanic', 
    'ESOL',
    'Migrant'
  )) +
  labs(x = 'Percent of School', 
       y = '', 
       color = 'Harsh Punishments per Student', 
       shape = 'Harsh Punishments per Student', 
       caption = 'Most = top 10%; Least = bottom 10%') +
  theme_minimal() + 
  scale_color_OkabeIto()

```

```{r}
school_animation <- 
  school_plot + 
  transition_states(states = category, transition_length = 2) + 
  labs(title = 'Schools with the {closest_state} 
Harsh Punishments per Student') + 
  theme(plot.title = element_text(hjust=0.5, size=rel(3)), 
        #plot.caption = element_text(hjust=0.5, size=rel(3)), 
        axis.text.y = element_text(size = rel(2)), 
        axis.text.x = element_text(size = rel(2)), 
        legend.title = element_text(size = rel(2)),
        legend.text = element_text(size = rel(2)), 
        legend.position = 'bottom') + 
  enter_fade() +    
  exit_fade() 

school_gif <- animate(school_animation, 
                      nframes = 10, 
                      fps = 1,
                      height = 600, 
                      width = 800 
                      )
```

```{r}
lmertree_TA <- dat_final %>% 
  mutate(`% Black` = perc_black, 
         `School Type` = factor(fac_schtype, 
                                 levels =c('E', 'M', 'H', 'K12'), 
                                 labels =c('E', 'M', 'H', 'K12')),
         `% FRL` = perc_frl) %>% 
  lmertree(
     formula = 
       harsh_ps ~ 1 | 
       (1 | district/`School Type`) | 
       total +
       `School Type` + 
       `% Black` + 
       perc_hisp + 
       perc_migrant + 
       perc_esol + 
       `% FRL` +
       d_black + 
       d_hisp + 
       d_migrant + 
       d_esol + 
       d_frl, 
     alpha = 0.001, 
     bonferroni = T, 
     cluster = district,
     minsize = 230)

```

```{r}
asterisk_sign <- function(p_value) {
  if (p_value < 0.001) return(c("p_value < 0.001"))
  if (p_value < 0.01) return(c("p_value < 0.01"))
  if (p_value < 0.05) return(c("p_value < 0.05"))
  else return("")}

p1 <- lmertree_TA$tree[1]

tree <-
  ggparty(p1) +
  geom_edge(size = 1.2) +
  geom_edge_label() +
  geom_node_label(aes(label = splitvar), 
                  ids = "inner") +
  geom_node_plot(gglist = list(
    geom_boxplot(aes(y = harsh_ps, 
                     color = `School Type`)), 
    labs(y = 'Punishments/Student'),
    theme_minimal(),
    theme(axis.text.x = element_blank(), 
          axis.ticks.x = element_blank(), 
          axis.line.x = element_line(size = 1.5), 
          axis.line.y = element_line(size = 1.5), 
          panel.grid.minor.x = element_blank(), 
          panel.grid.major.x = element_blank()),
    lims(y = c(0, 1.5))), 
    shared_axis_labels = T) +
  geom_node_label(
    line_list = list(aes(label = paste('N = ' , nodesize)),
                     aes(label = splitvar),
                     aes(label = asterisk_sign(p.value))),
    # set graphical parameters for each line
    line_gpar = list(
      list(size = 7,
        col = "black",
        fontface = "bold"),
      list(size = 11),
      list(size = 7)),
    ids = "inner") +
  geom_node_label(
    aes(label = paste0("N = ", nodesize)),
    fontface = "bold",
    ids = "terminal") + 
  labs(title = 'Mixed Effects Regression Tree of Harsh Punishments per Students') +
  theme(plot.title = element_text(hjust = 0.5))
```

```{r}
# Geographic Data (Teachers & Admin Page)

#GA <- lea_get(state = 'GA') 
#maptools::writeSpatialShape(GA, here::here('Data', 'GA_map'))

GA_1 <- maptools::readShapeSpatial(here::here('Data', 'GA_map.shp'))

# GA_sf <- 
#   lea_get(state = 'GA') %>%

GA_sf <- GA_1 %>% 
  st_as_sf() %>% 
  mutate(district = 
           str_replace(string = NAME, 
                       pattern = " District", ""), 
         district = 
           str_replace(string = district, 
                       pattern = " Schools", ""), 
         district = 
           str_replace(string = district, 
                       pattern = " School", "")
         )
```

```{r}
dat_district <- 
  dat_final %>% 
  select(district, district_size, starts_with('d_')) %>% 
  unique()

GA_districts <- 
  GA_sf %>% 
  left_join(dat_district) %>% 
  mutate(harsh_qt = factor(ntile(d_harsh, 5)), 
         black_qt = factor(ntile(d_black, 5)))
```

```{r}
b_map <- GA_districts %>% 
  mutate(`Harsh Punishments per Student` = round(d_harsh, 2), 
    Demographics = paste('\n', '(', district, ')',
                         '\n', round(d_black, 1), '% Black', 
                         '\n', round(d_hisp, 1), '% Hispanic', 
                         '\n', round(d_migrant, 1), '% Migrant', 
                         '\n', round(d_frl, 1), '% FRL', 
                         sep = "")
         ) %>% 
  ggplot(aes(geometry = geometry)) + 
  geom_sf(aes(fill = `Harsh Punishments per Student`, text = Demographics)) +
  scale_fill_distiller(palette = "Blues", direction = -1) + 
  theme_void()  +
  theme(legend.position = 'bottom') +
  labs(fill = 'Harsh Punishments per Student',
       title = 'Distribution Harsh Punishments per Student') 

plotly_map1 <- 
  ggplotly(b_map) 

```

General 
===

Column {data-width=350, .tabset}
-----------------------------------------------------------------------

### Index & Walk-Thru

**1. Page 1: intended for anyone.** This page includes:

  * **Figure 1**, an interactive map of Georgia which shows distribution of **harsh punishments per student** & **percents of demographic characteristics** in each school districts (drag an area to zoom in, double click to zoom out, hover the mouse along *district borders* to see information)
  * **Background information** for the project (See *Introduction* tab behind this one)
  * **Useful definitions** of terms used throughout (See *Introduction* tab behind this one)

**2. Page 2: intended for school admin & education policy makers.** This page includes:

  * **Figure 2**, an animated plot showing the demographic characteristics of schools with **the most harsh punishments per student** versus **schools with the least harsh punishments per student**. 
  * **Explanations of these differences** along with **recommendations for admins and policy makers**
  * **(Searchable) school-level data for every school in Georgia**

**3. Page 3: intended for researchers and analysts.** This page includes:

  * **Figure 3**, a plot made from a mixed effects regression trees model that explores heterogeneity (a.k.a. subgroup differences) in harsh punishments per student at the school- and district-level. 
  * (An abbreviated) **Methods & Results** section for this model 


### Introduction

**Background**

As a former teacher and a prevention scientist, I can say disciplinary actions are given to students inequitably; sometimes this can be chalked up to circumstantial differences, but often it's due to biases carried by the administration.

Such inequities manifest as [Black students recieving a disproportionate number of "exclusionary" disciplinary actions](https://epaa.asu.edu/ojs/article/viewFile/2787/1911), compared to their other racial-ethnic counterparts—particularly White students. 

"Exclusionary disciplinary action" is any action which removes a student from the school (e.g., suspension, expulsion, etc.). Such exclusionary punishments are shown to [contribute directly to the school-to-prison pipeline](https://www.tandfonline.com/doi/full/10.1080/10665684.2014.958965). This is not meant to be a deep-dive into the literature, but this [Google Scholar](https://scholar.google.com/scholar?hl=en&as_sdt=0%2C38&q=inequity+in+student+discipline&btnG=) link can get you started if you're interested. 

Other punishments besides these exclusionary actions can be detrimental to a child's perceived belonging, trust in the school as an institution, and feeling of safety. Georgia — among other states — retains an antiquated form of student discipline, which can have iatrogenic effects: [corporal punishment, most often manifested as "paddling" (i.e., spanking a child with a large wooden paddle)](https://www.theguardian.com/us-news/2018/sep/12/georgia-school-innovation-classics-paddle-students#:~:text=the%20United%20States.-,Georgia%20is%20one%20of%2018%20states%20where%20corporal%20punishment%20remains,of%20corporal%20punishment%20each%20year). 

**Current Project**

This dashboard is an exploratory analysis of inequity in **harsh punishments** among demographic characteristics in Georgia schools, defined as: 

  * Permanent expulsion
  * Out of school suspension
  * Juvenile court referral
  * Corporal punishment 
  * Physical restraint
  
Technically, physical restraint *is not a legal form of punishment* by [Georgia Law](https://safesupportivelearning.ed.gov/sites/default/files/discipline-compendium/Georgia%20School%20Discipline%20Laws%20and%20Regulations.pdf), however it is reported by the [GA Department of Education](https://www.gadoe.org/data-reporting/Pages/default.aspx) alongside other punishments, suggesting it's used enough to need to be tracked (and making my definition of a "harsh punishment"). Importantly, no results change appreciably when this one aspect is omitted.
  
**Data**

The data set represents 2,141 schools in 198 districts across the state of Georgia, and merges data from the [Governer's Office of Student Achievement](https://gosa.georgia.gov/report-card-dashboards-data/downloadable-data) and the [Georgia Department of Education](https://www.gadoe.org/data-reporting/Pages/default.aspx). 

Single imputation was used for all models, as pooling multiple imputed data sets is not interpretable to the target audience (and is not integrated into mixed effects regression trees). Imputation was done with the `{mice}` package with all variables included in the data set. Missingness in state-reported data stems from districts which had numbers too small to report. As previously stated, the data can be seen on Page 2


Column {data-width=650, .tabset} 
-----------------------------------------------------------------------

### Figure 1.

```{r }
plotly_map1 
```


School Admin
===

column {data-width=500, .tabset}
-----------------------------------------------------------------------

### School-Level Info

```{r}
dat_school_level <-
  dat_final %>% 
  transmute(school_name,
            district = district,
            harsh_punishments = harsh, 
            harsh_per_student = harsh_ps,
            school_type = factor(fac_schtype, 
                                 levels = c('E', 'M', 'H', 'K12'), 
                                 labels = c('Elementary', 'Middle', 'High', 'K-12')),
            number_of_students = total, 
            percent_black = perc_black, 
            percent_hispanic = perc_hisp, 
            percent_white = perc_white, 
            percent_migrant = perc_migrant, 
            percent_ESOL = perc_esol, 
            out_of_school_suspension = out_of_school_suspension_oss,
            juvenile_court_referral,
            physical_restraint,
            corporal_punishment,
            permanent_expulsion) %>% 
  mutate_if(is.numeric, round)
  
reactable(dat_school_level, 
    filterable = T,
    highlight = T, 
    striped = T, 
    outlined = T,
    defaultSorted = c('harsh_per_student'),
    defaultColDef = colDef(
      header = function(x) str_to_title(gsub("_", " ", x))
    ),
    defaultSortOrder = 'desc'
  )
```


### Figure 2 Explanation

**How exactly do schools who give many harsh punishments per student compare to those who give very few?**

**Figure 2** compares demographic characteristics for schools with the fewest (i.e., bottom 10%) and most (i.e., top 10%) harsh punishments per student.

Schools who give the fewest harsh punishments per student have a fairly even spread of % FRL students, often have low % Black students, and have high % White students. Schools who give the most harsh punishments per student almost exclusively have high % FRL students, high % Black students, and often low % White students. 

This necessitates both a deeper investigation into the equity in use of these harsh punishments and exploration of possible alternative punishments that allow students to learn from mistakes in a school setting. Teachers and Administration in districts with such demographics should examine the way that they — and their coworkers — interact with low-income and Black students. 

Simple recommendations include: 

  * Blind review of punishment-worthy incidents and their respective punishments. 
  * Formation of a larger panel — including student representatives and people of color — to handle disciplinary actions. 
  * Use of evidence-based strategies for disciplinary action which have been shown to change student behavior, rather than simply removal from school ground.
  * Focus on rehabilitative action, rather than punitive action.
  * Incorporation of an equity framework to punishment.
  * Choosing leadership strategies that can close the racial discipline gap.
  * Reading important literature on [the problem](https://link.springer.com/content/pdf/10.1023/A:1021320817372.pdf), [appropriate leadership styles](https://www.tandfonline.com/doi/pdf/10.1080/00098655.2015.1121120), etc.

**How much does disciplinary action change across percent FRL Eligible and percent Black students per school?**

Comparing schools in the top 20% of %FRL eligible to those in the bottom 20% shows **400x more harsh punishments** for schools with the highest %FRL compared to the lowest %FRL. Similar comparisons for percent Black students show **almost 350x more harsh punishments** in schools with the top 20% of % Black students compared to those in the bottom 20% of % Black students.


column {data-width=500, .tabset}
-----------------------------------------------------------------------

### Figure 2.

```{r}
school_gif
```

Researchers
===

Column {data-width=500, .tabset}
-----------------------------------------------------------------------

### Description 

**What test was conducted?**

Parameter instability tests are relatively infrequently used tools in education, probably because their long-standing inability to take into account nested data structures (like those made by schools nested in districts). Recent advancements from [Zeileis, Hothorn, and Hornik's (2008)](https://www.tandfonline.com/doi/abs/10.1198/106186008X319331) general linear model regression trees have extended them to incorporate such nesting, thanks to [Fokkema & Zeileis (2018)](https://pubmed.ncbi.nlm.nih.gov/29071652/). Such models are extremely powerful and flexible. They use recursive partitioning to find subgroup differences in any regression model, as well as determining which variables moderate the relationship specified to varying degrees. 

These models allow you to specify a mixed-effect model and provide partitioning variables. After accounting for level-2 variance, the model runs many linear models and determines which parameters differ along partitioning variables. A variant of an *F* test is then used to determine if differences among partitioning variables are significant at a pre-specified alpha, controlling for inflation with Bonferroni corrections. If these differences are significant, subsequent splits can be identified, which would suggest an interactive effect. When variables appear higher in the tree, they are "more important" to the model, meaning that variable creates more homogeneous subgroups than those below. 

**How was missing data handled and how was the model specified?**

Single imputation was used to fill missing data. The model shown here only reports group differences at the *p* < 0.001, after Bonferroni corrections, and with the minimum acceptable node as as 10% of the total sample (i.e., 230 schools/node). The model was estimated with restricted maximum likelihood (REML) with the `{glmertree}` package. 

An intercept-only model was fit for harsh discipline per student at the school level. Conditional variances were specified such that schools were nested in their districts. The model explored for parameter instability across level-1 and level-2 with all school- and district-level covariates (e.g., percent racial/ethnic composition, percent FRL status, percent English second language, and percent migrant students). To control for dependencies, variances of school types (elementary, middle, etc.) were specified to be nested within their districts.

### Results

**Figure 3** shows results of this exploratory model. The bottom of the model essentially reads as boxplots for the subgroup specified by the tree. Boxplots within one cell are not significantly different from one another, but are significantly different from boxplots of other subgroups. 

The variable which shows the greatest inequity in harsh punishments per student is school type, with middle and high schools displaying higher average harsh punishments per student than elementary and K-12 schools. Among middle and high schools, schools with higher than ~75% FRL eligible student have higher average harsh punishments per student than those with less than ~75%. Among schools that are less than ~75% FRL, schools with 32% (or more) Black students have more harsh punishments than those with less than 32%.

Among elementary and middle schools, the variable which creates greatest instability in estimation of the intercept is percent Black students, with schools that have more than 35% Black students displaying higher average harsh punishments per student. 

An **important note** here is that the figure actually shows the entire distribution across elementary and middle schools, but many outliers for middle and high schools were omitted from this visualization to make comparison of the average and interquartile ranges easier. 

The model predicts:

**Middle and high schools with more than ~75% FRL eligible students** average **~1 harsh punishment for every 3 students**. 

**Middle and high schools with less than ~75% FRL eligible students and more than 32% Black students** average **~1 harsh punishment for every 5 students**. 

**Middle and high schools with less than ~75% FRL eligible students and less than 32% Black students** average **~1 harsh punishment for every 10 students**. 

**Elementary and K-12 schools with less than 35% Black students** average **1 harsh punishment per every 20 students**. 

**Elementary and K-12 schools with more than 35% Black students**, we see more than **1 harsh punishment per every 10 students**.

This provides evidence that there is significant inequity in distribution of harsh punishments per student across schools, family income (i.e., FRL status), and percent Black students. Next steps should explore interventions which can improve administrative decision-making to minimize such inequity. 


Column {data-width=500, .tabset}
-----------------------------------------------------------------------

### Figure 3. 

```{r}
tree
```

