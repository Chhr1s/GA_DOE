---
title: "EDLD 652 Final"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    social: menu
    source_code: https://chhr1s.github.io/GA_DOE_Public/docs/index.html/
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(rio)
library(here)
library(janitor)
library(sf)
library(leaidr)
library(tigris)
library(gt)
library(lme4)
library(lmerTest)
library(glmertree)
library(plotly)
library(colorblindr)
library(ggparty)
library(gganimate)
options(tigris_use_cache = TRUE)
options(tigris_class = "sf")


```


```{r import, include = F}
frl <- import(here("Data", "Free Reduced Lunch (FRL) Fiscal Year2019 Data Report_Schools.csv")) %>% 
  clean_names() %>% 
  mutate(kk_12_percent_frl = as.numeric(kk_12_percent_frl) 
         #kk_12_percent_frl = replace_na(kk_12_percent_frl, 0)
         ) %>% 
  separate(col = school_id_school_name, 
           into = c('school_id','school_name'), 
           sep = " - ",
           extra = "merge") %>% 
  filter(system_name != 'N/A') %>% 
  select(-system_id)

all_students <-  #https://gosa.georgia.gov/report-card-dashboards-data/downloadable-data
  import(
    here('Data',
         'Enrollment_By_Grade_Level_2019_Dec2nd_2019.csv')) %>%
  clean_names() %>% 
  filter(enrollment_period == 'Fall') %>% 
  group_by(instn_name) %>% 
  summarize(num_students = sum(enrollment_count)) %>% 
  transmute(school_name = instn_name, 
            total = num_students)


school_demos <- import(
    here('Data', #https://gosa.georgia.gov/report-card-dashboards-data/downloadable-data
  'Enrollment_by_Subgroups_Programs_2019_OCT_22_2020.csv')) %>% 
  clean_names() %>% 
  transmute(school_name = instn_name,
            system_name = school_dstrct_nm,
            perc_black = enroll_percent_black,
            perc_hisp = enroll_percent_hispanic, 
            perc_white = enroll_percent_white, 
            perc_non_white = 100-perc_white, 
            perc_migrant = enroll_percent_migrant, 
            perc_esol = enroll_pct_esol
            )
  
schools <- school_demos %>%
  full_join(all_students)

disc_action <- import(
  here("Data", 
       "sr2019_discipline_action_counts_sch.xlsx")
  ) %>% 
  clean_names() %>% 
  select(-grade_range, -school_year) %>% 
  left_join(frl)

  ### There are a problem with districts where no schools reported FRL
  ### In these districts, the average of all = 0 (with na.rm = T), 
  ### Unsure how to handle these...


dat <- disc_action %>% 
  inner_join(schools) %>% # if this is left_join I have to impute
  group_by(system_name) %>% 
  mutate(harsh =
           out_of_school_suspension_oss +
           juvenile_court_referral +
           physical_restraint +
           corporal_punishment +
           permanent_expulsion, # +
           #in_school_suspension_iss,
         harsh_ps = harsh/total, 
         harsh_per_100 = harsh_ps*100,
         district = factor(system_name),
         school_name = factor(school_name), 
         fac_schtype = factor(fac_schtype), 
         perc_frl = kk_12_percent_frl 
         ) %>% 
  mutate(district_size = sum(total, na.rm = T), 
         d_black = sum(total*perc_black, na.rm = T)/district_size, 
         d_hisp = sum(total*perc_hisp, na.rm = T)/district_size, 
         d_non_white = sum(total*perc_non_white, na.rm = T)/district_size, 
         d_white = sum(total*perc_white, na.rm = T)/district_size, 
         d_esol = sum(total*perc_esol, na.rm = T)/district_size,
         d_migrant = sum(total*perc_migrant, na.rm = T)/district_size,
         d_frl = sum(total*kk_12_percent_frl, na.rm = T)/district_size, 
         d_harsh = sum(harsh, na.rm = T)/district_size) %>% 
  ungroup() 
dat_small <- 
  dat %>% 
  select(district, 
         district_size, 
         school_name, 
         fac_schtype, 
         total,
         contains('frl'),
         contains('black'), 
         contains('hisp'), 
         contains('white'), 
         contains('migrant'), 
         contains('esol'), 
         contains('harsh')) %>% 
  select(-kk_12_percent_frl)

dat_long <- dat_small %>% 
  pivot_longer(contains('perc'), 
               names_to = 'school_demos', 
               names_prefix = 'perc_', 
               values_to = 'percents')

#dat_small[rowSums(is.na(dat_small)) > 0,]

rm(list=setdiff(ls(), c("dat", 'dat_small', 'dat_long')))


```

```{r, include = F, echo = F}
target_schools <- 
  dat_small %>% 
  mutate(harsh_10 = ntile(harsh_ps, 10)) %>% 
  filter(harsh_10 == 10) %>% 
  map_dfr(mean, na.rm = T) %>% 
  mutate(category = '90th percentile')

exemplar_schools <- 
  dat_small %>% 
  mutate(harsh_10 = ntile(harsh_ps, 10)) %>% 
  filter(harsh_10 == 1) %>% 
  map_dfr(mean, na.rm = T) %>% 
  mutate(category = '10th Percentile')

comparison_schools <- 
  bind_rows(target_schools, exemplar_schools) %>% 
  select(-district, 
         -contains('non_white'),
         -district_size, 
         -school_name, 
         -fac_schtype,
         -starts_with('d_')) %>% 
  pivot_longer(starts_with('perc_'),
               names_to = 'demographics', 
               names_prefix = 'perc_',
               values_to = 'percent') 

comparison_districts <- 
  bind_rows(target_schools, exemplar_schools) %>% 
  select(-district, 
         -district_size, 
         -contains('non_white'),
         -school_name, 
         -fac_schtype,
         -starts_with('perc_'), 
         -d_harsh) %>% 
  pivot_longer(starts_with('d_'),
               names_to = 'district_demographics', 
               names_prefix = 'd_',
               values_to = 'percent')

school_plot <- comparison_schools %>% 
  ggplot(aes(y = 
               fct_reorder(demographics, percent), 
             x = percent, 
             fill = category)) + 
  geom_col(position = 'dodge') +
  lims(x = c(0,100)) +
  scale_y_discrete(breaks = c(
    'black', 
    'frl', 
    'white',
    'hisp', 
    'esol', 
    'migrant'
  ),
    labels = c(
    'Black Students', 
    'FRL Eligible',
    'White Students', 
    'Hispanic Students', 
    'ESOL Students',
    'Migrant Students'
  )) +
  labs(fill = 'Harsh Punishments Per Student', 
       title = 'School Characteristics',
       #subtitle = 'Schools with most & least harsh punishments per student',
       y = '', 
       x = 'Percent (%)') +
  theme_minimal() + 
  theme(legend.position = 'bottom', 
        plot.title.position = 'plot') +
  scale_fill_OkabeIto()

district_plot <- 
  comparison_districts %>% 
  ggplot(aes(y = 
               fct_reorder(district_demographics, percent), 
             x = percent, 
             fill = category)) + 
  geom_col(position = 'dodge') + 
  labs(fill = 'Harsh Punishments Per Student', 
       title = 'District Characteristics',
       #subtitle = 'Schools with most & least harsh punishments per student',
       y = '', 
       x = 'Percent (%)') +
  lims(x = c(0,100)) +
  theme_minimal() + 
  scale_y_discrete(breaks = c(
    'black', 
    'frl', 
    'white',
    'hisp', 
    'esol', 
    'migrant'
  ),
  labels = c(
    'Black Students', 
    'FRL Eligible',
    'White Students', 
    'Hispanic Students', 
    'ESOL Students',
    'Migrant Students'
  )) +
  theme(legend.position = 'bottom', 
        plot.title.position = 'plot') +  
  scale_fill_OkabeIto()

  ## CONSIDER CALCULATING STANDARD ERRORS
  ## TALK ABOUT THESE AS INTERVENTION TARGETS
```

```{r eval=FALSE, include=FALSE}
lmertree_TA <- dat_small %>% 
  mutate(`% Black` = perc_black, `School Type` = fac_schtype) %>% 
  lmertree(
     formula = 
       harsh_ps ~ 1 | 
       (1 | district/`School Type`) | 
       total +
       `School Type` + 
       `% Black` + 
       perc_hisp + 
       perc_migrant + 
       perc_esol + 
       perc_frl +
       d_black + 
       d_hisp + 
       d_migrant + 
       d_esol + 
       d_frl, 
     alpha = 0.001, 
     bonferroni = T, 
     minsize = 224)

p1 <- lmertree_TA$tree[1]

asterisk_sign <- function(p_value) {
  if (p_value < 0.001) return(c("p_value < 0.001"))
  if (p_value < 0.01) return(c("p_value < 0.01"))
  if (p_value < 0.05) return(c("p_value < 0.05"))
  else return("")
}

```

```{r eval=FALSE, include=FALSE}

 ## if we add the line back in with the replace_na() then it works out
 ## now it changes the plot
tree <-
ggparty(p1) +
  geom_edge(size = 1.2) +
  geom_edge_label() +
  geom_node_label(aes(label = splitvar), 
                  ids = "inner") +
  geom_node_plot(gglist = list(
    geom_point(
      aes(
        x = `% Black`,
        y = harsh_ps,
        color = `School Type`),
      alpha = 0.7),
    geom_smooth(
      method = 'lm',
      aes(
        x = `% Black`,
        color = `School Type`,
        y = harsh_ps),
      alpha = 0.7),
    lims(y = c(0,1)),
    labs(y = 'Punishments/Student'),
    theme_minimal()), 
    shared_axis_labels = T) + 
  geom_node_label(# label nodes with ID, split variable and p value
                  line_list = list(aes(label = paste('N = ' , nodesize)),
                                   aes(label = splitvar),
                                   aes(label = asterisk_sign(p.value))),
                  # set graphical parameters for each line
                  line_gpar = list(list(#size = 8,
                                        col = "black",
                                        fontface = "bold"),
                                   list(size = 12),
                                   list(size = 8)
                                   ),
                  ids = "inner") +
  geom_node_label(aes(label = paste0("N = ", nodesize)),
                  fontface = "bold",
                  ids = "terminal",
                  ) + 
  labs(title = 'Mixed Effects Regression Tree of Harsh Punishments per Students') +
  theme(plot.title = element_text(hjust = 0.5))

tree
ggsave('tree_plot.png', tree, path = here::here('Data'))
```


```{r, echo = F}
summary_1 <- dat_small %>% 
  mutate(`Quintile of Percent Black Students` = ntile(perc_black, 5)) %>% 
  group_by(`Quintile of Percent Black Students`) %>% 
  summarize(`Average Percent Black Students in Quintile` = mean(perc_black), 
           `Average Harsh Punishments per Student` = mean(harsh_ps))

comparison_1 <- summary_1$`Average Harsh Punishments per Student`[1]

percent_change_1 <- summary_1 %>% 
  mutate(`% Increase in Punishments from 1st` = 
           (`Average Harsh Punishments per Student`- comparison_1)/comparison_1*100)

```

```{r, eval = T, include = F}
# Geographic Data (Teachers & Admin Page)
GA_sf <- 
  lea_get(state = 'GA') %>% 
  st_as_sf() %>% 
  mutate(district = 
           str_replace(string = NAME, 
                       pattern = " District", ""), 
         district = 
           str_replace(string = district, 
                       pattern = " Schools", ""), 
         district = 
           str_replace(string = district, 
                       pattern = " School", "")
         )

```

```{r, eval = T, include = F}
#disc_demo %>% filter(system_name == 'Macon County')

dat_district <- 
  dat_small %>% 
  select(district, district_size, starts_with('d_')) %>% 
  unique()

GA_districts <- 
  GA_sf %>% 
  left_join(dat_district) %>% 
  mutate(harsh_qt = factor(ntile(d_harsh, 5)), 
         black_qt = factor(ntile(d_black, 5)),
         frl_qt = ntile(d_frl, 5), 
         harsh_3 = ntile(d_harsh, 3), 
         black_3 = ntile(d_black, 3), 
         frl_3 = ntile(d_frl, 3))
```


```{r include=FALSE}
b_map <- GA_districts %>% 
  mutate(`Quintile Harsh Punishment` = harsh_qt,
    Demographics = paste('\n', '(', district, ')',
                         '\n', round(d_black, 1), '% Black', 
                         '\n', round(d_hisp, 1), '% Hispanic', 
                         '\n', round(d_migrant, 1), '% Migrant', 
                         '\n', round(d_frl, 1), '% FRL', 
                         sep = "")
         ) %>% 
  ggplot(aes(geometry = geometry)) + 
  geom_sf(aes(fill = `Quintile Harsh Punishment`, text = Demographics)) +
  scale_fill_manual(
    values =
      c('#a9c2f4',
        '#7ca2ee',
        '#4f82e8',
        '#2262e2',
        '#184eb9'),
    na.value = '#6a6b6c') +
  theme_void()  +
  labs(fill = 'Quintile Harsh Punishments',
       title = 'Distribution Harsh Punishments per Student')


plotly_map1 <- 
  ggplotly(b_map) 

```

General 
===

Column {data-width=250}
-----------------------------------------------------------------------

### Introduction

**Background**

In a school setting, student discipline is not completely objective. School admins bring bias into their decision-making process. The interactive map shows harsh punishments per student, represented as quintiles of the underlying distribution, for each district. In addition to these, district names and several district demographic characteristics are presented by hovering over a district line.

**Useful Definitions:** 

* A *quintile* is exactly 20% (or $\frac1{5^{th}}$) of the population; these are formed by arranging a variable in order and dividing the distribution into 5 equal bins. A district in the $1^{st}$ quintile for harsh punishments per student is one of the 20% of districts with the fewest harsh punishments per student.

* Harsh punishments are defined here as:

  * Out of school suspension
  * Juvenile court referral
  * Physical restraint
  * Corporal punishment
  * Permanent expulsion
  
* FRL = Free and Reduced-Price Lunch Status. Because this is related to family income, this is often used as a crude approximation of a child coming from a low-income family. 
  
**Data**

The data set represents 2,141 schools in 198 districts across the state of Georgia, and merges data from the [Governer's Office of Student Achievement](https://gosa.georgia.gov/report-card-dashboards-data/downloadable-data) and the [Georgia Department of Education](https://www.gadoe.org/data-reporting/Pages/default.aspx). 


Column {data-width=750}
-----------------------------------------------------------------------
### Figure 1. Interactive Map 

```{r}
plotly_map1 
```

School Admin
===


Column {data-width=350}
-----------------------------------------------------------------------

### Profiles of Schools

**How exactly do schools who give many harsh punishments per student compare to those who give few?**

**Figure 2** compares demographic characteristics for schools with the fewest and most harsh punishments per student at the school and district level. Schools which give the most harsh punishments per student have many more free/reduced-price lunch eligible students than those who give the least. These schools also have many more black students and many fewer white students. Similar differences can be seen at the district level.

**How does the number of harsh punishments per school increase with percent black students in the school?**

**Table 1** shows schools in the bottom 20% of percent black students

### Table 1

```{r}
percent_change_1 %>% 
  round(digits = 3) %>% 
  gt() %>% 
  tab_header(
    title = 'Increase in Harsh Punishments with Quintile of Percent Black Students',
  )
```


Column {data-width=650}
-----------------------------------------------------------------------
### Figure 2. Characteristics of schools with the most harsh punishments per student versus those with the fewest

```{r}
gridExtra::grid.arrange(school_plot, district_plot) 
```

Researchers
===

Column {data-width=350}
-----------------------------------------------------------------------

### Chart A

```{r}

```


### Chart B

Column {data-width=650}
-----------------------------------------------------------------------

### Chart C

```{r, fig.width = 7.95, fig.height = 6.19}
#fig.width=9.86, fig.height=6.19
tree_pic <- png::readPNG(here::here('Data', 'tree_plot.png')) 
grid::grid.raster(tree_pic)
```

```{r, include = F, eval = F}
lmer <- lmer(data = dat_small, 
     formula = 
       harsh ~
       total +
       fac_schtype + 
       perc_black + 
       perc_hisp + 
       perc_migrant + 
       perc_esol + 
       frl +
       d_black + 
       d_hisp + 
       d_migrant + 
       d_esol + 
       d_frl +
       (1 | district))

summary(lmer)



lmertree <- 
  lmertree(data = dat_small, 
     formula = 
       harsh ~ total + perc_black | 
       (1 | district/fac_schtype) | 
       total +
       fac_schtype + 
       perc_black + 
       perc_hisp + 
       perc_migrant + 
       perc_esol + 
       frl +
       d_black + 
       d_hisp + 
       d_migrant + 
       d_esol + 
       d_frl, 
     alpha = 0.001, 
     bonferroni = T, 
     minsize = 224)

lmertree
summary(lmertree$tree)

sqrt(sum(residuals(lmertree)^2))
sqrt(sum(residuals(lmer)^2))

plot(lmertree, ask = F, which = 'all')


py <- lmertree$tree[1]

ggparty(py) +
  geom_edge() +
  geom_edge_label() +
  geom_node_label(aes(label = splitvar), ids = "inner") +
  geom_node_plot(gglist = list(geom_point(aes(x = perc_black, y = harsh, color = perc_black),
                                          alpha = 0.5
    # geom_density(aes(x = harsh_per_100)), lims(x = c(0,100))
    #                            #xlab("play")
    ), geom_smooth(aes(x = perc_black, y = harsh), se = T, method = 'lm')))

```

```{r, include = F, eval = F}
dat_small <- 
  dat_small %>% 
  mutate(prediction = predict(lmertree))

dat_small %>% 
  ggplot(aes(x = prediction, y = harsh)) + 
  geom_point(aes(color = perc_black, shape = fac_schtype), alpha = 0.5) +
  coord_fixed() + 
  lims(x = c(0, 2500), y = c(0,2500)) + 
  geom_abline(intercept = 0, slope = 1) + 
  facet_wrap(~fac_schtype)

dat_small <- dat_small %>% 
  mutate(difference = abs(harsh - prediction), 
         act_difference = harsh - prediction, 
         sign = if_else(harsh - prediction < 0, 0, 1), # positives have higher than predicted
         difference_rank = factor(ntile(difference, 10)), 
         very_bad = factor(if_else(difference_rank %in% c(10), 1, 0)))



unusual_schools <-
  glmer(data = dat_small,
     formula = sign ~ 
       #harsh +
       #total +
       fac_schtype + 
       perc_black + 
       perc_hisp + 
       perc_migrant + 
       perc_esol + 
       frl +
       d_black +
       d_hisp +
       d_migrant +
       d_esol +
       d_frl +
       (1 | district), 
     family = 'binomial'
     ) 

summary(unusual_schools)

dat_small %>% 
  ggplot(aes(x = prediction, y = harsh)) + 
  geom_point(aes(color = very_bad, shape = fac_schtype), alpha = 0.5) +
  coord_fixed() + 
  lims(x = c(0, 2500), y = c(0,2500)) + 
  geom_abline(intercept = 0, slope = 1) + 
  facet_wrap(~fac_schtype)
```

```{r, include = F, eval = F}
misfits <- 
  dat_small %>%
  filter(very_bad == 1) 
  # group_by(sign) %>% 
  # summarize(average_perc_black = mean(perc_black))

rf_def_mod <-
  rand_forest() %>%
  set_engine("ranger",
             num.threads = cores, #argument from {ranger}
             importance = "permutation", #argument from {ranger}
             verbose = TRUE) %>% #argument from {ranger} 
  set_mode("classification")

```


```{r, include = F, eval = F}
agg_disc_perc_complete %>% 
  mutate(lm1 = predict(lm1)) %>% 
  ggplot(aes(x = lm1, y = harsh)) + 
  geom_point() +
  geom_abline(intercept = 0, slope = 1) + 
  lims(x = c(0, .3), y = c(0, .3))


disagg_perc_complete %>% 
  mutate(lm2 = predict(lm2)) %>% 
  ggplot(aes(x = lm2, y = harsh)) + 
  geom_point()+
  geom_abline(intercept = 0, slope = 1) + 
  lims(x = c(0, .3), y = c(0, .3))

disagg_perc_complete %>% 
  mutate(lmer1 = predict(lmer1)) %>% 
  ggplot(aes(x = lmer1, y = harsh)) + 
  geom_point()+
  geom_abline(intercept = 0, slope = 1) + 
  lims(x = c(0, .3), y = c(0, .3))

```

```{r, include = F, eval = F}
t1 <-tibble(.rows = 1)

for (i in list(lm1, lm2, lmer1)){
  next_resid <<-tibble(sqrt(mean(residuals(i)^2)), .rows = 1)
  t1 <<- cbind(t1, next_resid) 
}
columns <- 
  list('lm1', 'lm2', 'lmer1')

colnames(t1) <- columns

rmse <- 
  t1 %>% 
  pivot_longer('lm1':'lmer1', 
               names_to = 'model',
               values_to = 'rmse') %>% 
  mutate(model = factor(model, levels = columns, 
                        labels = c('simple linear model aggregated',
                                   'simple linear model disaggregated',
                                   'simple mixed-effects model')))
rmse
```
